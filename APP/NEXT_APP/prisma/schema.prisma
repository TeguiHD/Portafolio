generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String                   @id @default(cuid())
  email               String                   @unique
  emailEncrypted      String?
  password            String
  name                String?
  role                Role                     @default(USER)
  isActive            Boolean                  @default(true)
  avatar              String?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  failedLoginAttempts Int                      @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  auditLogs           AuditLog[]
  budgets             Budget[]
  categoryFeedbacks   CategoryFeedback[]
  cvVersions          CvVersion[]
  financeAccounts     FinanceAccount[]
  financeAuditLogs    FinanceAuditLog[]
  financeCategories   FinanceCategory[]
  products            Product[]
  quotations          Quotation[]
  chatSessions        QuotationChatSession[]
  quotationClients    QuotationClient[]
  receipts            Receipt[]
  recurringPayments   RecurringPayment[]
  savingsGoals        SavingsGoal[]
  sessions            Session[]
  transactions        Transaction[]
  categorizationRules UserCategorizationRule[]
  permissions         UserPermission[]
  userSessions        UserSession[]
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserSession {
  id           String    @id @default(cuid())
  userId       String
  tokenId      String    @unique
  ipAddress    String?
  userAgent    String?
  browser      String?
  device       String?
  os           String?
  city         String?
  country      String?
  countryCode  String?
  lastActivity DateTime  @default(now())
  createdAt    DateTime  @default(now())
  expiresAt    DateTime
  isActive     Boolean   @default(true)
  revokedAt    DateTime?
  revokeReason String?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([ipAddress])
  @@index([expiresAt])
}

model Permission {
  id            String           @id @default(cuid())
  code          String           @unique
  name          String
  description   String?
  category      String
  defaultRoles  Role[]
  createdAt     DateTime         @default(now())
  userOverrides UserPermission[]

  @@index([category])
}

model UserPermission {
  id           String     @id @default(cuid())
  userId       String
  permissionId String
  granted      Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  category   String
  userId     String?
  targetId   String?
  targetType String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([category])
  @@index([createdAt])
}

model SecurityIncident {
  id         String           @id @default(cuid())
  type       String
  severity   SecuritySeverity @default(MEDIUM)
  ipHash     String
  path       String?
  userAgent  String?
  userId     String?
  details    Json?
  resolved   Boolean          @default(false)
  resolvedAt DateTime?
  resolvedBy String?
  resolution String?
  createdAt  DateTime         @default(now())

  @@index([type])
  @@index([severity])
  @@index([resolved])
  @@index([ipHash])
  @@index([createdAt])
  @@index([severity, resolved, createdAt])
}

model ContactMessage {
  id          String          @id @default(cuid())
  email       String
  name        String?
  message     String
  ipHash      String
  userAgent   String?
  source      String          @default("landing")
  status      ContactStatus   @default(UNREAD)
  priority    ContactPriority @default(NORMAL)
  response    String?
  respondedBy String?
  respondedAt DateTime?
  isSpam      Boolean         @default(false)
  spamScore   Int             @default(0)
  spamReason  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([email])
  @@index([isSpam])
}

model PageView {
  id        String   @id @default(cuid())
  path      String
  referrer  String?
  userAgent String?
  ip        String?
  country   String?
  createdAt DateTime @default(now())
}

model CtaClick {
  id        String   @id @default(cuid())
  action    String
  label     String?
  metadata  Json?
  referrer  String?
  userAgent String?
  createdAt DateTime @default(now())
}

model Quotation {
  id            String           @id @default(cuid())
  folio         String           @unique
  clientName    String
  clientEmail   String?
  projectName   String
  items         Json
  subtotal      Float
  discount      Float            @default(0)
  total         Float
  validDays     Int              @default(15)
  paymentTerms  String?
  timeline      String?
  notes         String?
  status        String           @default("draft")
  isVisible     Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  userId        String
  clientId      String?
  htmlContent   String?
  accessCode    String?
  accessMode    String           @default("code")
  codeExpiresAt DateTime?
  slug          String?
  client        QuotationClient? @relation(fields: [clientId], references: [id])
  user          User             @relation(fields: [userId], references: [id])

  @@unique([clientId, slug])
  @@index([slug])
  @@index([userId])
}

model QuotationClient {
  id              String      @id @default(cuid())
  name            String                          // Nombre comercial / empresa
  slug            String      @unique
  
  // Información de la empresa
  company         String?                         // Razón social (si difiere del name)
  rut             String?                         // RUT de la empresa
  address         String?                         // Dirección
  
  // Información del representante/contacto
  contactName     String?                         // Nombre del representante
  contactEmail    String?                         // Email del representante
  contactPhone    String?                         // Teléfono/WhatsApp
  contactRole     String?                         // Cargo (Gerente, Encargado, etc.)
  
  // Legacy field (mantener para compatibilidad)
  email           String?
  
  accessCode      String
  isActive        Boolean     @default(true)
  notes           String?                         // Notas internas sobre el cliente
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  quotations      Quotation[]

  @@index([slug])
  @@index([userId])
}

// Security: Access log for quotation sharing
model QuotationAccessLog {
  id            String   @id @default(cuid())
  quotationId   String
  clientSlug    String
  quotationSlug String
  ipAddress     String
  userAgent     String?
  fingerprint   String?
  accessResult  String   // "success", "invalid_code", "expired", "rate_limited"
  createdAt     DateTime @default(now())
  
  @@index([quotationId, createdAt])
  @@index([ipAddress, createdAt])
  @@index([accessResult])
  @@index([createdAt])
}

model CvVersion {
  id             String            @id @default(cuid())
  name           String
  fullName       String
  title          String
  email          String
  phone          String
  location       String
  orcid          String?
  linkedin       String?
  github         String?
  website        String?
  summary        String?
  latexCode      String?
  pdfUrl         String?
  isDefault      Boolean           @default(false)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  userId         String
  certifications CvCertification[]
  education      CvEducation[]
  experiences    CvExperience[]
  languages      CvLanguage[]
  projects       CvProject[]
  skills         CvSkillCategory[]
  user           User              @relation(fields: [userId], references: [id])
}

model CvExperience {
  id           String    @id @default(cuid())
  cvVersionId  String
  company      String
  position     String
  startDate    String
  endDate      String?
  isCurrent    Boolean   @default(false)
  description  String?
  achievements String[]
  sortOrder    Int       @default(0)
  cvVersion    CvVersion @relation(fields: [cvVersionId], references: [id], onDelete: Cascade)

  @@index([cvVersionId])
}

model CvEducation {
  id          String    @id @default(cuid())
  cvVersionId String
  institution String
  degree      String
  field       String?
  startDate   String
  endDate     String?
  isCurrent   Boolean   @default(false)
  sortOrder   Int       @default(0)
  cvVersion   CvVersion @relation(fields: [cvVersionId], references: [id], onDelete: Cascade)

  @@index([cvVersionId])
}

model CvSkillCategory {
  id          String    @id @default(cuid())
  cvVersionId String
  category    String
  items       String[]
  sortOrder   Int       @default(0)
  cvVersion   CvVersion @relation(fields: [cvVersionId], references: [id], onDelete: Cascade)

  @@index([cvVersionId])
}

model CvProject {
  id           String    @id @default(cuid())
  cvVersionId  String
  name         String
  description  String?
  technologies String[]
  url          String?
  year         String?
  sortOrder    Int       @default(0)
  cvVersion    CvVersion @relation(fields: [cvVersionId], references: [id], onDelete: Cascade)

  @@index([cvVersionId])
}

model CvCertification {
  id          String    @id @default(cuid())
  cvVersionId String
  name        String
  issuer      String?
  year        String?
  url         String?
  sortOrder   Int       @default(0)
  cvVersion   CvVersion @relation(fields: [cvVersionId], references: [id], onDelete: Cascade)

  @@index([cvVersionId])
}

model CvLanguage {
  id          String    @id @default(cuid())
  cvVersionId String
  language    String
  level       String
  sortOrder   Int       @default(0)
  cvVersion   CvVersion @relation(fields: [cvVersionId], references: [id], onDelete: Cascade)

  @@index([cvVersionId])
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}

model Tool {
  id          String      @id @default(cuid())
  slug        String      @unique
  name        String
  description String?
  icon        String?
  category    String?
  isPublic    Boolean     @default(false)
  isActive    Boolean     @default(true)
  sortOrder   Int         @default(0)
  config      Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  usages      ToolUsage[]
}

model ToolUsage {
  id        String   @id @default(cuid())
  toolId    String
  action    String
  sessionId String?
  ip        String?
  country   String?
  device    String?
  browser   String?
  userAgent String?
  metadata  Json?
  createdAt DateTime @default(now())
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@index([toolId, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
}

model RateLimitEntry {
  id          String   @id @default(cuid())
  identifier  String   @unique
  ip          String?
  fingerprint String?
  cookieId    String?
  count       Int      @default(1)
  windowStart DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([identifier])
  @@index([windowStart])
}

model QuotationChatSession {
  id          String                 @id @default(cuid())
  userId      String
  quotationId String?
  isActive    Boolean                @default(true)
  summary     String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  messages    QuotationChatMessage[]
  user        User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([userId, quotationId])
}

model QuotationChatMessage {
  id        String               @id @default(cuid())
  sessionId String
  role      String
  content   String
  actions   Json?
  createdAt DateTime             @default(now())
  session   QuotationChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
}

model AdminNotification {
  id           String               @id @default(cuid())
  type         NotificationType
  priority     NotificationPriority @default(MEDIUM)
  title        String
  message      String
  metadata     Json?
  targetRole   Role?
  targetUserId String?
  actorId      String?
  actorName    String?
  isRead       Boolean              @default(false)
  readAt       DateTime?
  readBy       String?
  createdAt    DateTime             @default(now())
  expiresAt    DateTime?

  @@index([targetRole, isRead, createdAt])
  @@index([targetUserId, isRead])
  @@index([createdAt])
}

model Currency {
  id           String           @id @default(cuid())
  code         String           @unique
  name         String
  symbol       String
  decimals     Int              @default(2)
  isActive     Boolean          @default(true)
  accounts     FinanceAccount[]
  transactions Transaction[]

  @@index([code])
}

model ExchangeRateCache {
  id             String   @id @default(cuid())
  baseCurrency   String   @default("EUR")
  targetCurrency String
  rate           Float
  fetchedAt      DateTime @default(now())

  @@unique([baseCurrency, targetCurrency])
  @@index([targetCurrency])
  @@index([fetchedAt])
}

model FinanceAccount {
  id               String        @id @default(cuid())
  userId           String
  name             String
  type             AccountType   @default(CHECKING)
  currencyId       String
  initialBalance   Float         @default(0)
  currentBalance   Float         @default(0)
  color            String?
  icon             String?
  isDefault        Boolean       @default(false)
  isActive         Boolean       @default(true)
  sortOrder        Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  currency         Currency      @relation(fields: [currencyId], references: [id])
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionsFrom Transaction[] @relation("FromAccount")
  transactionsTo   Transaction[] @relation("ToAccount")

  @@unique([userId, name])
  @@index([userId, isActive])
}

model FinanceCategory {
  id                String             @id @default(cuid())
  userId            String?
  name              String
  icon              String
  color             String?
  type              TransactionType
  parentId          String?
  keywords          String[]
  isActive          Boolean            @default(true)
  sortOrder         Int                @default(0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  budgets           Budget[]
  feedbacks         CategoryFeedback[]
  parent            FinanceCategory?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children          FinanceCategory[]  @relation("CategoryHierarchy")
  user              User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  recurringPayments RecurringPayment[]
  transactions      Transaction[]

  @@unique([userId, name, type])
  @@index([userId, type, isActive])
  @@index([type])
}

model Transaction {
  id                      String            @id @default(cuid())
  userId                  String
  type                    TransactionType
  amount                  Float
  description             String?
  merchant                String?
  notes                   String?
  categoryId              String?
  accountId               String
  toAccountId             String?
  currencyId              String
  originalAmount          Float?
  exchangeRate            Float?
  transactionDate         DateTime          @default(now())
  receiptId               String?
  documentType            String?
  documentNumber          String?
  merchantRut             String?
  recurringPaymentId      String?
  autoCategorizationScore Float?
  wasManuallyEdited       Boolean           @default(false)
  source                  String            @default("manual")
  isDeleted               Boolean           @default(false)
  deletedAt               DateTime?
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  account                 FinanceAccount    @relation("FromAccount", fields: [accountId], references: [id], onDelete: Cascade)
  category                FinanceCategory?  @relation(fields: [categoryId], references: [id])
  currency                Currency          @relation(fields: [currencyId], references: [id])
  receipt                 Receipt?          @relation(fields: [receiptId], references: [id])
  recurringPayment        RecurringPayment? @relation(fields: [recurringPaymentId], references: [id])
  toAccount               FinanceAccount?   @relation("ToAccount", fields: [toAccountId], references: [id])
  user                    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  items                   TransactionItem[]

  @@index([userId, transactionDate])
  @@index([userId, categoryId])
  @@index([userId, accountId])
  @@index([userId, type, transactionDate])
  @@index([merchant])
  @@index([documentNumber])
}

model TransactionItem {
  id            String      @id @default(cuid())
  transactionId String
  description   String
  quantity      Float       @default(1)
  unitPrice     Float
  totalPrice    Float
  productId     String?
  sku           String?
  category      String?
  createdAt     DateTime    @default(now())
  product       Product?    @relation(fields: [productId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([productId])
  @@index([description])
}

model Product {
  id              String            @id @default(cuid())
  userId          String
  name            String
  normalizedName  String
  sku             String?
  barcode         String?
  category        String?
  lastPrice       Float?
  avgPrice        Float?
  minPrice        Float?
  maxPrice        Float?
  priceCount      Int               @default(0)
  purchaseCount   Int               @default(0)
  lastPurchased   DateTime?
  commonMerchants String[]          @default([])
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  items           TransactionItem[]

  @@unique([userId, normalizedName])
  @@index([userId, category])
  @@index([normalizedName])
  @@index([barcode])
}

model Receipt {
  id             String        @id @default(cuid())
  userId         String
  filename       String
  storagePath    String
  mimeType       String
  fileSize       Int
  documentType   String?
  documentNumber String?
  barcodeData    String?
  siiCode        String?
  merchantRut    String?
  ocrProvider    String?
  ocrRawText     String?
  ocrParsedData  Json?
  ocrConfidence  Float?
  status         String        @default("pending")
  errorMessage   String?
  processedAt    DateTime?
  fileDeletedAt  DateTime?
  createdAt      DateTime      @default(now())
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions   Transaction[]

  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([documentNumber])
}

model RecurringPayment {
  id           String           @id @default(cuid())
  userId       String
  name         String
  amount       Float
  currencyId   String
  categoryId   String?
  accountId    String?
  frequency    String
  dayOfMonth   Int?
  dayOfWeek    Int?
  startDate    DateTime
  endDate      DateTime?
  nextDueDate  DateTime
  reminderDays Int              @default(3)
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  category     FinanceCategory? @relation(fields: [categoryId], references: [id])
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId, isActive])
  @@index([userId, nextDueDate])
}

model Budget {
  id           String           @id @default(cuid())
  userId       String
  name         String?
  categoryId   String?
  amount       Float
  period       BudgetPeriod     @default(MONTHLY)
  alertAt75    Boolean          @default(true)
  alertAt90    Boolean          @default(true)
  alertAt100   Boolean          @default(true)
  currentSpent Float            @default(0)
  periodStart  DateTime
  periodEnd    DateTime
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  category     FinanceCategory? @relation(fields: [categoryId], references: [id])
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  alerts       BudgetAlert[]

  @@unique([userId, categoryId, period])
  @@index([userId, isActive])
}

model BudgetAlert {
  id          String      @id @default(cuid())
  budgetId    String
  threshold   Int
  percentage  Float
  amount      Float
  status      AlertStatus @default(ACTIVE)
  dismissedAt DateTime?
  createdAt   DateTime    @default(now())
  budget      Budget      @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId, status])
}

model SavingsGoal {
  id            String    @id @default(cuid())
  userId        String
  name          String
  icon          String?
  color         String?
  targetAmount  Float
  currentAmount Float     @default(0)
  deadline      DateTime?
  milestone25   Boolean   @default(false)
  milestone50   Boolean   @default(false)
  milestone75   Boolean   @default(false)
  completed     Boolean   @default(false)
  completedAt   DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
}

model CategoryFeedback {
  id                  String          @id @default(cuid())
  userId              String
  merchant            String?
  description         String?
  amount              Float?
  predictedCategoryId String?
  correctCategoryId   String
  ruleCreated         Boolean         @default(false)
  createdAt           DateTime        @default(now())
  correctCategory     FinanceCategory @relation(fields: [correctCategoryId], references: [id])
  user                User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, merchant])
  @@index([userId, ruleCreated])
}

model UserCategorizationRule {
  id                 String   @id @default(cuid())
  userId             String
  merchantPattern    String?
  descriptionPattern String?
  minAmount          Float?
  maxAmount          Float?
  categoryId         String
  priority           Int      @default(0)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
}

model FinanceAuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String?
  oldValue   Json?
  newValue   Json?
  source     String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, action])
  @@index([userId, entityType, entityId])
  @@index([createdAt])
}

enum Role {
  SUPERADMIN
  ADMIN
  MODERATOR
  USER
}

enum SecuritySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ContactStatus {
  UNREAD
  READ
  RESPONDED
  ARCHIVED
  SPAM
}

enum ContactPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationType {
  USER_CREATED
  USER_ROLE_CHANGED
  USER_SUSPENDED
  USER_ACTIVATED
  USER_DELETED
  PASSWORD_CHANGED
  LOGIN_RATE_LIMITED
  QUOTATION_CREATED
  QUOTATION_STATUS_CHANGED
  TOOL_STATUS_CHANGED
  TOOL_USAGE_SPIKE
  SYSTEM_ERROR
  SYSTEM_MAINTENANCE
  CONCURRENT_SESSION_DETECTED
  SESSION_FROM_NEW_LOCATION
  SESSION_REVOKED
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum AccountType {
  CASH
  CHECKING
  SAVINGS
  CREDIT_CARD
  INVESTMENT
  OTHER
}

enum BudgetPeriod {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum AlertStatus {
  ACTIVE
  TRIGGERED
  DISMISSED
}
